<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shubham Shinde">
<meta name="dcterms.date" content="2023-10-08">
<meta name="description" content="A from-scratch guide to deploying a tensorflow-lite model on cloud using AWS Free-tier">

<title>Shubham Shinde - A Beginner’s Guide to Deploying Tensorflow Models on AWS Lambda (Free-Tier)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-E3Z2GSDBB7"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-E3Z2GSDBB7', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Shubham Shinde - A Beginner’s Guide to Deploying Tensorflow Models on AWS Lambda (Free-Tier)">
<meta property="og:description" content="A from-scratch guide to deploying a tensorflow-lite model on cloud using AWS Free-tier">
<meta property="og:image" content="https://shindeshu.github.io/posts\cloud\assets\coverart.png">
<meta property="og:site-name" content="Shubham Shinde">
<meta property="og:image:height" content="1024">
<meta property="og:image:width" content="1024">
<meta name="twitter:title" content="Shubham Shinde - A Beginner’s Guide to Deploying Tensorflow Models on AWS Lambda (Free-Tier)">
<meta name="twitter:description" content="A from-scratch guide to deploying a tensorflow-lite model on cloud using AWS Free-tier">
<meta name="twitter:image" content="https://shindeshu.github.io/posts\cloud\assets\coverart.png">
<meta name="twitter:creator" content="@ShindeShubham85">
<meta name="twitter:image-height" content="1024">
<meta name="twitter:image-width" content="1024">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Shubham Shinde</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">About</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">Blog</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#whats-this-post-about" id="toc-whats-this-post-about" class="nav-link active" data-scroll-target="#whats-this-post-about">What’s This Post About</a>
  <ul class="collapse">
  <li><a href="#what-is-aws-lambda-serverless" id="toc-what-is-aws-lambda-serverless" class="nav-link" data-scroll-target="#what-is-aws-lambda-serverless">What is AWS Lambda / Serverless</a></li>
  </ul></li>
  <li><a href="#conversion-to-tf-lite" id="toc-conversion-to-tf-lite" class="nav-link" data-scroll-target="#conversion-to-tf-lite">Conversion to TF-Lite</a>
  <ul class="collapse">
  <li><a href="#why-tf-lite" id="toc-why-tf-lite" class="nav-link" data-scroll-target="#why-tf-lite">Why TF-Lite</a></li>
  <li><a href="#conversion" id="toc-conversion" class="nav-link" data-scroll-target="#conversion">Conversion</a></li>
  <li><a href="#the-docker-image-for-lambda-function" id="toc-the-docker-image-for-lambda-function" class="nav-link" data-scroll-target="#the-docker-image-for-lambda-function">The Docker Image for Lambda Function</a></li>
  <li><a href="#build-the-docker-image" id="toc-build-the-docker-image" class="nav-link" data-scroll-target="#build-the-docker-image">Build the Docker Image</a></li>
  <li><a href="#testing-the-docker-application" id="toc-testing-the-docker-application" class="nav-link" data-scroll-target="#testing-the-docker-application">Testing the Docker Application</a></li>
  </ul></li>
  <li><a href="#setup-your-free-tier-aws-account" id="toc-setup-your-free-tier-aws-account" class="nav-link" data-scroll-target="#setup-your-free-tier-aws-account">Setup your Free-tier AWS Account</a>
  <ul class="collapse">
  <li><a href="#signup-for-a-free-tier-account" id="toc-signup-for-a-free-tier-account" class="nav-link" data-scroll-target="#signup-for-a-free-tier-account">Signup for a Free-tier Account</a></li>
  <li><a href="#creating-an-iam-user" id="toc-creating-an-iam-user" class="nav-link" data-scroll-target="#creating-an-iam-user">Creating an IAM User</a></li>
  <li><a href="#setup-aws-cli" id="toc-setup-aws-cli" class="nav-link" data-scroll-target="#setup-aws-cli">Setup AWS-CLI</a></li>
  <li><a href="#create-and-link-amazon-ecr" id="toc-create-and-link-amazon-ecr" class="nav-link" data-scroll-target="#create-and-link-amazon-ecr">Create and Link Amazon ECR</a></li>
  <li><a href="#upload-the-docker-image-to-ecr-repo" id="toc-upload-the-docker-image-to-ecr-repo" class="nav-link" data-scroll-target="#upload-the-docker-image-to-ecr-repo">Upload the Docker Image to ECR Repo</a></li>
  </ul></li>
  <li><a href="#creating-the-lambda-function" id="toc-creating-the-lambda-function" class="nav-link" data-scroll-target="#creating-the-lambda-function">Creating the Lambda Function</a>
  <ul class="collapse">
  <li><a href="#test-the-image" id="toc-test-the-image" class="nav-link" data-scroll-target="#test-the-image">Test the Image</a></li>
  <li><a href="#create-a-api-gateway" id="toc-create-a-api-gateway" class="nav-link" data-scroll-target="#create-a-api-gateway">Create a API Gateway</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">A Beginner’s Guide to Deploying Tensorflow Models on AWS Lambda (Free-Tier)</h1>
  <div class="quarto-categories">
    <div class="quarto-category">data-science</div>
    <div class="quarto-category">deep-learning</div>
    <div class="quarto-category">cloud</div>
  </div>
  </div>

<div>
  <div class="description">
    A from-scratch guide to deploying a tensorflow-lite model on cloud using AWS Free-tier
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Shubham Shinde </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 8, 2023</p>
    </div>
  </div>
    
  </div>
  

</header>

<section id="whats-this-post-about" class="level2">
<h2 class="anchored" data-anchor-id="whats-this-post-about">What’s This Post About</h2>
<p>If you are a data scientist, have no idea about cloud, and want to do something hands-on instead of courses- you are in the right place.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/coverart.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Generated Using SDXL</figcaption><p></p>
</figure>
</div>
<p>In this blogpost, we will signup on AWS Free-tier account and use the Lambda service to deploy a trained ML model within the free-tier limits. The code used in this post is available <a href="https://github.com/shindeshu/aws_lambda_tflite">in this repo</a>.</p>
<p>Pre-requisites:</p>
<ol type="1">
<li><p>You should be able to know how to train a machine learning model. Here, we are taking an already trained keras model and start from that point. It is a CNN model that classifies given image into either <code>cat</code> or <code>dog</code>. But if you are interested in the model training aspect, check out <a href="https://www.kaggle.com/code/shindeshubham85/a-friendly-introduction-to-cnns-in-keras">this kaggle notebook</a>!</p></li>
<li><p>You should be familiar with basics of Docker and REST API.</p></li>
</ol>
<p>The contents of this blogpost:</p>
<ul>
<li>Take the trained Keras Model, and convert to tf-lite format (Why? Discussed later.)</li>
<li>Write and test the inference functions for tf-lite model.</li>
<li>Create a docker image using an AWS Lambda image as base, and test it out.</li>
<li>Signup for an AWS Free-tier account. Configure the AWS CLI and ECR (Discussed later.)</li>
<li>Create an AWS Lambda function using the docker image. Test it out.</li>
<li>Create an API Gateway and expose it. That is it!</li>
</ul>
<p>A visual depiction of the flow:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/flow.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Flow</figcaption><p></p>
</figure>
</div>
<p>This process is taken from the chapter 9 of the <a href="https://www.youtube.com/watch?v=MqI8vt3-cag&amp;list=PL3MmuxUbc_hIhxl5Ji8t4O6lPAOpHaCLR">free course “ML Zoomcamp”</a> by Alexey Grigorev, with some modifications. Follow the videos if you want a detailed walkthrough.</p>
<section id="what-is-aws-lambda-serverless" class="level3">
<h3 class="anchored" data-anchor-id="what-is-aws-lambda-serverless">What is AWS Lambda / Serverless</h3>
<p>AWS Lambda is a compute service that lets you run code without provisioning or managing servers.</p>
<p>All it asks is for you to bring the code- and the service will do everything else- provisioning servers, managing them, auto-scaling them if the demand increases, and shutting them off if they are not in use, or restarting them. Since we don’t need to worry at all about servers, it is also called serverless.</p>
<p>In the ML scenario, we will bring the code and the model to the service, and it will produce the predictions of our inputs. Instead of giving the code and the model directly, we will first package them inside a docker image, and use the image to deploy on Lambda.</p>
<p>At the end of this post, we can give a URL of an image to a REST API endpoint, and get back the image classification result.</p>
</section>
</section>
<section id="conversion-to-tf-lite" class="level2">
<h2 class="anchored" data-anchor-id="conversion-to-tf-lite">Conversion to TF-Lite</h2>
<section id="why-tf-lite" class="level3">
<h3 class="anchored" data-anchor-id="why-tf-lite">Why TF-Lite</h3>
<p>Our starting point is a file called <code>cats_and_dogs.h5</code> which is a keras model trained to classify given image into cat or dog. We can easily load it into our environment using the keras library.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tensorflow.keras.models.load_model(<span class="st">"cats_and_dogs.h5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, this may not be the best case for deploying the model. Installation of tensorflow itself can take up a LOT of memory. Importing the library also adds latency. We only need to do inference, while the library contains tools for many operations like training, etc. AWS Lambda does not support GPUs, so we don’t those sections of codebase either.</p>
<p>Other constraints are the free-tier limits of AWS: Since we are deploying in the cloud, the sizes of our docker image need to be under 500MB.</p>
<p>One way to remove the boilerplate from the libraries is to convert the model to tf-lite and use the tf-lite library, which we will be employing here.</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that AWS Lambda only supports CPUs, not GPUs. So we need to deploy models only if they can perform well on CPUs.</p>
<p>While TF-Lite supports GPUs, if your deployment is in a GPU-environment, you might be better off with other well-supported compilers like TensorRT.</p>
</div>
</div>
</section>
<section id="conversion" class="level3">
<h3 class="anchored" data-anchor-id="conversion">Conversion</h3>
<p>The code for conversion is pretty straightforward:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow.lite <span class="im">as</span> tflite </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>converter <span class="op">=</span> tflite.TFLiteConverter.from_keras_model(model)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>tflite_model <span class="op">=</span> converter.convert()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.io.gfile.GFile(<span class="st">'artifacts/cats_and_dogs.tflite'</span>, <span class="st">'wb'</span>) <span class="im">as</span> f:</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    f.write(tflite_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The tricky part is feeding the input and retrieving the output. Fortunately its all wrapped up neat here:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_tflite():</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    this function is used to load the tflite model and initialize the </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">    interpreter, and also return the input and output indexes</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    interpreter <span class="op">=</span> tflite.Interpreter(model_path<span class="op">=</span><span class="st">'cats_and_dogs.tflite'</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    interpreter.allocate_tensors()</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    input_details <span class="op">=</span> interpreter.get_input_details()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    input_index <span class="op">=</span> input_details[<span class="dv">0</span>][<span class="st">'index'</span>]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    output_details <span class="op">=</span> interpreter.get_output_details()</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    output_index <span class="op">=</span> output_details[<span class="dv">0</span>][<span class="st">'index'</span>]</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> interpreter, (input_index, output_index)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_with_tflite(interpreter, indexes, img):</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">    this function takes the interpreter, indexes and input image as input</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">    performs the inference, does some postprocessing and returns the result.</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    interpreter.set_tensor(indexes[<span class="dv">0</span>], img)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    interpreter.invoke()</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> interpreter.get_tensor(indexes[<span class="dv">1</span>])</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> postprocess(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Another tricky part is the pre-processing function. During training the model, we simply used the <code>keras.preprocessing</code> module to perform the pre-processing. Since we are not installing keras or tensorflow, how can we do the pre-processing?</p>
<p>Its easy, we do it ourselves. We load the image using PIL library, convert to numpy array, and scale it. The dependencies are light: PIL, and NumPy.</p>
<p>Now, we have the complete code for inference (<a href="https://github.com/shindeshu/aws_lambda_tflite/tree/main">check the github repo</a>)- including the pre-processing steps, and prediction with the tf-lite model.</p>
</section>
<section id="the-docker-image-for-lambda-function" class="level3">
<h3 class="anchored" data-anchor-id="the-docker-image-for-lambda-function">The Docker Image for Lambda Function</h3>
<p>Now, we will be creating a docker image to be used in lambda function. (Don’t worry about the AWS Account yet.)</p>
<p>While preparing a docker image we generally start with a “base image”. This often is based on Ubuntu. But this will not work here. We need to use the official AWS Lambda as base image which is based on CentOS and includes other artifacts related to Lambda. We will prepare our image from this base image, and upload to AWS Lambda for deployment.</p>
<p>How will we prepare the dockerfile?</p>
<ol type="1">
<li>Select the appropriate base image</li>
<li>Install the dependencies</li>
<li>Copy the lambda handler file</li>
<li>Copy the artifacts (model file etc.)</li>
<li>Specify the CMD command</li>
</ol>
<section id="creating-the-lambda-handler-file" class="level4">
<h4 class="anchored" data-anchor-id="creating-the-lambda-handler-file">Creating the Lambda Handler File</h4>
<p>Before we start preparing the Dockerfile, we need to write a python script <code>lambda_function.py</code> that will perform all the pre-processing steps, load the model and do prediction. This is going to be the entrypoint script for the Lambda function.</p>
<p>This script should have a function called <code>lambda_handler</code> that should take the input from API and return result as json.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lambda_handler(event, context):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> event[<span class="st">'url'</span>]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> load_image(url)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> predict_with_tflite(X)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here, <code>load_image</code> contains the preprocessing logic and <code>predict_with_tflite</code> contains the prediction steps. Check the complete <code>lambda_function.py</code> file in the github repo.</p>
</section>
<section id="resolving-some-errors" class="level4">
<h4 class="anchored" data-anchor-id="resolving-some-errors">Resolving Some Errors</h4>
<p>While installing the dependencies, you might come across some errors. This is related to the library <code>tf-lite</code>, the PyPI binaries are based on Ubuntu/Debian OS and not supported for CentOS. Hence, you will have to install this library using wheel files compiled for that OS- which are fortunately available for us on github, <a href="https://github.com/alexeygrigorev/tflite-aws-lambda">compiled by Alexey Grigorev</a>. A copy of the file is also present in the repo we are working from.</p>
</section>
</section>
<section id="build-the-docker-image" class="level3">
<h3 class="anchored" data-anchor-id="build-the-docker-image">Build the Docker Image</h3>
<p>Once the required code and model files are ready, we start building the docker image. The sequence of steps is simple:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> public.ecr.aws/lambda/python:3.8</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> artifacts/tflite_runtime-2.7.0-cp38-cp38-linux_x86_64.whl .</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip3</span> install tflite_runtime-2.7.0-cp38-cp38-linux_x86_64.whl <span class="at">--no-cache-dir</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install requests Pillow</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> artifacts/cats_and_dogs.tflite .</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> artifacts/lambda_function.py .</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"lambda_function.lambda_handler"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We build the image using</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> cats_and_dogs .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And start running the container using</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-it</span> <span class="at">--rm</span> cats_and_dogs:latest <span class="at">-p</span> 8080:8080 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="testing-the-docker-application" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-docker-application">Testing the Docker Application</h3>
<p>Now, the docker container is running, and presumably our model within is running as well. But how do we use it or test it if it’s working?</p>
<p>We send a request using the python <code>requests</code> library. If you go to our lambda handler script, the <code>event</code> argument is basically the json that we are sending over using a POST request. We retrieve the URL from the json payload, process it to get the prediction, and return the result as json response. Let’s look at the code:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"http://localhost:8080/2015-03-31/functions/function/invocations"</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># this is how the URL for AWS Lambda always looks like</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># this is the URL where the application inside docker container is listening for requests</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {<span class="st">"url"</span>: <span class="st">"https://t4.ftcdn.net/jpg/00/97/58/97/360_F_97589769_t45CqXyzjz0KXwoBZT9PRaWGHRk5hQqQ.jpg"</span>}</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># this is the input we want to give to the lambda_handler script</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> requests.post(url, json<span class="op">=</span>data).json()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># this is the result after prediction and post-processing.</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you are seeing a dictionary printed that contains the probabilities of the model classes, the docker container is running successfully! Congratulations - all our offline work is complete. All that’s left is signing up and moving this image to cloud.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that we did not install any client like FastAPI/Flask, yet we are able to listen to a REST API. The base docker image likely has a built-in server.</p>
</div>
</div>
</section>
</section>
<section id="setup-your-free-tier-aws-account" class="level2">
<h2 class="anchored" data-anchor-id="setup-your-free-tier-aws-account">Setup your Free-tier AWS Account</h2>
<section id="signup-for-a-free-tier-account" class="level3">
<h3 class="anchored" data-anchor-id="signup-for-a-free-tier-account">Signup for a Free-tier Account</h3>
<p>If you don’t have any experience in handling cloud, and want to learn- AWS Free-tier is a good option. But it can also be dreaded option, since some might be afraid of racking up large costs accidently. However if you understand the limits, it’s very easy to stay below the specified thresholds and still learn the nuts-and-bolts of AWS using toy projects.</p>
<p>Before you start creating a free-tier account, it’s best if you go through which services are free and what are their limits- <a href="https://aws.amazon.com/free/">https://aws.amazon.com/free/</a>. Also go through a <a href="https://www.youtube.com/watch?v=SFaSB6vgp8k">video example of setting up an account</a> so there’s less surprises.</p>
<p>Once the setup is complete, there’s still more steps to do for configuring your workspace.</p>
</section>
<section id="creating-an-iam-user" class="level3">
<h3 class="anchored" data-anchor-id="creating-an-iam-user">Creating an IAM User</h3>
<p>Once you have the account set up, you will have one user called ‘root’. However it’s a best practice to create custom users called “IAM Users” for development activity. Create one such user with admin access, and create an access key for this user. We will do our development through this access key.</p>
</section>
<section id="setup-aws-cli" class="level3">
<h3 class="anchored" data-anchor-id="setup-aws-cli">Setup AWS-CLI</h3>
<p>We can use AWS through our browser and the UI, but the best Developer Experience is through AWS Command Line Interface. This allows us to work from the terminal. Setting it up is easy,</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install awscli</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Configure it using <code>aws configure</code> and input the access ID and secret access keys you generated earlier. Input a default region (e.g.&nbsp;us-east-1, ap-south-1) and default format (e.g.&nbsp;json).</p>
</section>
<section id="create-and-link-amazon-ecr" class="level3">
<h3 class="anchored" data-anchor-id="create-and-link-amazon-ecr">Create and Link Amazon ECR</h3>
<p>ECR is Amazon’s container registry, where we can upload docker images. These images we can then use for various applications like AWS Lambda or AWS EKS etc. We will setup ECR and connect it our docker client (Docker Desktop), so that we can upload docker images from docker to ECR.</p>
<ol type="1">
<li>We first create an ECR Repo, and <em>note down the URI</em></li>
</ol>
<p><code>aws ecr create-repository --repository-name cats_and_dogs_images</code></p>
<p>You can go to the AWS dashboard in your browser and check if the repository has been created.</p>
<ol start="2" type="1">
<li>Authenticate docker to work with ECR.</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> <span class="va">$(</span><span class="ex">aws</span> ecr get-login<span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>For windows, Step2 might result in an error. <a href="https://stackoverflow.com/a/65858904">This solution from stackoverflow</a> worked for me.</p>
</div>
</div>
<p>Following these steps, Docker is successfully authenticated with AWS-ECR.</p>
</section>
<section id="upload-the-docker-image-to-ecr-repo" class="level3">
<h3 class="anchored" data-anchor-id="upload-the-docker-image-to-ecr-repo">Upload the Docker Image to ECR Repo</h3>
<ol type="1">
<li>Tag the image of interest with the remote repository URI</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> tag cats_and_dogs:latest <span class="va">${REMOTE_URI}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li>Push to ECR</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> push</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Check in browser if the image has been published.</p>
</section>
</section>
<section id="creating-the-lambda-function" class="level2">
<h2 class="anchored" data-anchor-id="creating-the-lambda-function">Creating the Lambda Function</h2>
<p>Now, your AWS Account is set up and you’ve also uploaded the docker image to ECR. In this section we will use the image to create a lambda function, and also set an API trigger using API Gateway.</p>
<p>Creating a Lambda function is easy, from the AWS dashboard we go to AWS Lambda -&gt; Create Function -&gt; From Image -&gt; Select the Uploaded image.</p>
<p><img src="assets/create.png" class="img-fluid"></p>
<section id="test-the-image" class="level3">
<h3 class="anchored" data-anchor-id="test-the-image">Test the Image</h3>
<p>By default the timeout is 3s, which we need to increase to 30s in the settings. This is because the model loading for the first time may take upto 7s. We can test the lambda function by giving the json payload in the test area.</p>
<p>If you get the familiar output of classes and probabilities, your Lambda function is working!</p>
<p>However, currently you can only give the input through the test section. How will the users access the function? How will they connect to Lambda? We can use Amazon’s API Gateway for that.</p>
</section>
<section id="create-a-api-gateway" class="level3">
<h3 class="anchored" data-anchor-id="create-a-api-gateway">Create a API Gateway</h3>
<p>From Dashboard, go to API Gateway -&gt; REST API -&gt; new resource. Here you define the endpoint name. Then, define the request type (i.e.&nbsp;POST) In POST, integration type should be changed to Lambda function. Give the region name and name of the lambda function we created earlier.</p>
<p>So you have now exposed the Lambda function using a REST API! You can test it there itself in the request body section.</p>
<p>But this API Endpoint is still private- we can open it up to other users by going to Actions -&gt; Deploy API. We copy the URL, and test it using python requests library.</p>
<p>And this is how we deploy an ML model using AWS Lambda!</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>